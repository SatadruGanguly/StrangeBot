def chatWindow(request):
    user = User.objects.filter(username=request.user.username)[0]
    myuser = MyUser.objects.filter(user_ref=user)[0]
    chats = ChatRecords.objects.filter(user_ref=myuser).order_by('sentat')
    form = ChatForm()
    context_dict = {'chats': chats, 'form': form}
    if request.method == 'POST':
        filled_form = ChatForm(request.POST)
        if filled_form.is_valid():
            # print('User Message : '+filled_form.cleaned_data['message'])
            form_data = filled_form.save(commit=False)
            form_data.user_ref = myuser
            form_data.sentby = 'User'
            form_data.save()
    return render(request, 'MedBotApp/chat.html', context=context_dict)



if request.user.is_authenticated:
        user = User.objects.filter(username=request.user.username)[0]
        myuser = MyUser.objects.filter(user_ref=user)[0]
        chats = ChatRecords.objects.filter(user_ref=myuser).order_by('sentat')
        if myuser:
            myuser = myuser[0]
        else:
            c = ChatRecords(user_ref=myuser, message=ChatBot.welcome(), sentby='User')
            c.save()


def chatWindow(request):
    user = User.objects.filter(username=request.user.username)[0]
    myuser = MyUser.objects.filter(user_ref=user)[0]
    chats = ChatRecords.objects.filter(user_ref=myuser).order_by('sentat')
    chats = list(chats)
    welcome_flag = False
    if 'uscstate' in request.session.keys():
        uscstate = request.session['uscstate']
        print('Session Key Present : ', request.session['uscstate'])
    else:
        request.session['uscstate'] = -1
        uscstate = request.session['uscstate']
        print('Session Key Created : ', request.session['uscstate'])
    if uscstate == -1:
        welcome = ChatRecords(user_ref=myuser, message=ChatBot.welcome(), sentby='Bot')
        chats.append(welcome)
        welcome_flag = True
        print('welcome object created')
    form = ChatForm()
    context_dict = {'chats': chats, 'form': form}
    if request.method == 'POST':
        filled_form = ChatForm(request.POST)
        if filled_form.is_valid():
            # print('User Message : '+filled_form.cleaned_data['message'])
            if welcome_flag:
                welcome.save()
            form_data = filled_form.save(commit=False)
            form_data.user_ref = myuser
            form_data.sentby = 'User'
            form_data.save()
    return render(request, 'MedBotApp/chat.html', context=context_dict)